language: ruby
rvm: 2.4.1

git:
  depth: 10

matrix:
  include:
    - sudo: false
      dist: trusty
      env: SUDO=false DIST=trusty
    - sudo: required
      dist: trusty
      env: SUDO=required DIST=trusty

before_install:
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin
  - curl http://packages.couchbase.com/ubuntu/couchbase.key | sudo apt-key add -
  - "echo \"deb http://packages.couchbase.com/ubuntu trusty trusty/main\" | sudo tee -a /etc/apt/sources.list"
  - sudo apt-get update -qq
  - sudo apt-get install libcouchbase-dev libcouchbase2-bin
  - wget https://packages.couchbase.com/releases/4.5.1/couchbase-server-community_4.5.1-ubuntu14.04_amd64.deb
  - sudo dpkg -i ./couchbase-server-community_4.5.1-ubuntu14.04_amd64.deb
  - while ! nc -vz localhost 8091; do sleep 1; done
  - /opt/couchbase/bin/couchbase-cli cluster-init -c 127.0.0.1:8091 --cluster-username=Administrator --cluster-password=password --cluster-port=8091 --cluster-ramsize=1024
  - /opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=clicks --bucket-type=couchbase --bucket-ramsize=128 -u Administrator -p password --wait
  - /opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=device_click_mapping --bucket-type=couchbase --bucket-ramsize=128 -u Administrator -p password --wait
  - /opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=devices --bucket-type=couchbase --bucket-ramsize=128 -u Administrator -p password --wait
  - /opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=device_identifiers --bucket-type=couchbase --bucket-ramsize=128 -u Administrator -p password --wait
  - /opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=third_party_impression --bucket-type=couchbase --bucket-ramsize=128 -u Administrator -p password --wait

script: true
