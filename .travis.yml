dist: trusty
language: ruby
rvm:
  - 2.3.4
cache: bundler
addons:
  chrome: stable
  

env:
  - TAG=analytics
  - TAG=callmanagement
  - TAG=callrouting
  - TAG=calltracking
  - TAG=devtools
  - TAG=leadflow
  - TAG=integration
  - TAG=misc
  - TAG=notifications
  
install: skip
script: echo "bundle exec rspec --profile --tag $TAG"
  
jobs:
  include:
    - stage: healthcheck
      if: type IN (api, cron) AND env(HEALTH) = true
      env: TAG=healthcheck
      script: echo "bundle exec rspec --profile --tag $TAG"

    - stage: api-general
      if: type IN (api, cron) AND env(API_GEN) = true
      script:
       - 'bundle exec rspec spec/features/API/General/Phone_Number/**_spec.rb'
       - 'bundle exec rspec spec/features/API/General/**_spec.rb'
       - 'bundle exec rspec spec/features/API/General/IVR/**_spec.rb'

    - stage: api-leadflow
      if: type IN (api, cron) AND env(API_LF) = true
      script:
        - 'bundle exec rspec spec/features/API/LeadFlow/LFv2_Affiliates_spec.rb'
        - 'bundle exec rspec spec/features/API/LeadFlow/LFv2_History_spec.rb'
        - 'bundle exec rspec spec/features/API/LeadFlow/LFv2_Summary_spec.rb'

    - stage: api-analytics
      if: type IN (api, cron) AND env(API_ANALYTICS) = true
      script:
        - 'bundle exec rspec spec/features/API/Analytics/broadcast_report_spec.rb'
        - 'bundle exec rspec spec/features/API/Analytics/CDR_spec.rb'
        - 'bundle exec rspec spec/features/API/Analytics/click_to_spec.rb'
        - 'bundle exec rspec spec/features/API/Analytics/conversation_insight_spec.rb'
        - 'bundle exec rspec spec/features/API/Analytics/dashboard_insight_spec.rb'
        - 'bundle exec rspec spec/features/API/Analytics/dialog_analytics_spec.rb'
        - 'bundle exec rspec spec/features/API/Analytics/ivr_spec.rb'

    - stage: api-sourcetrak
      if: type IN (api, cron) AND env(API_ST) = true
      # script: 'bundle exec rspec spec/features/API/Attribution/SourceTrak/**_spec.rb'
      script:
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/domain_sets_get_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/domain_sets_end_to_end_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/location_end_to_end_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/locations_get_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/pools_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/st_activity_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/st_domain_set_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/st_number_replacement_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/st_page_hit_by_SID_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/SourceTrak/st_pool_spec.rb'

    - stage: api-bing
      if: type IN (api, cron) AND env(API_BING) = true
      script: 'bundle exec rspec spec/features/API/Attribution/Bing/**_spec.rb'

    - stage: api-custom-data
      if: type IN (api, cron) AND env(API_CD) = true
      script: 'bundle exec rspec spec/features/API/Attribution/CustomData/**_spec.rb'

    - stage: api-gce
      if: type IN (api, cron) AND env(API_GCE) = true
      script:
        - 'bundle exec rspec spec/features/API/Attribution/GCE/get_unmanaged_accounts_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/GCE/invalid_token_spec.rb'
        - 'bundle exec rspec spec/features/API/Attribution/GCE/missing_token_spec.rb'

    - stage: bid-management
      if: type IN (api, cron) AND env(BM) = true
      script: 'bundle exec rspec spec/features/API/Attribution/Bid_Management/**_spec.rb'

    - stage: cdr
      if: type IN (api, cron) AND env(CDR) = true
      script: "bundle exec rspec spec/features/UI/Analytics/CDR/CDR75_spec.rb"

    - stage: sourcetrak-end-to-end
      if: type IN (api, cron) AND env(SOURCETRAK) = true
      env: TAG=sourcetrak
      script: "bundle exec rspec --profile --tag $TAG"

    - stage: sourcetrak-cookies
      if: type IN (api, cron) AND env(ST_COOKIES) = true
      env: TAG=cookie
      script:
        - "bundle exec rspec --profile --tag $TAG"
        - 'bundle exec rspec spec/features/UI/CallTracking/SourceTrak/Cookies/st_l_single_location_cookie_spec.rb'
        - 'bundle exec rspec spec/features/UI/CallTracking/SourceTrak/Cookies/st_l_all_locations_cookie_spec.rb'

    - stage: insight
      if: type IN (api, cron) AND env(INSIGHT) = true
      env: TAG=insight
      script: "bundle exec rspec --profile --tag $TAG"

    - stage: call-processing
      if: type IN (api, cron) AND env(CALL) = true
      env: TAG=call
      script: "bundle exec rspec --profile --tag $TAG"

    - stage: call-processing-callflow
      if: type IN (api, cron) AND env(CALLFLOW) = true
      script: "spec/features/CallProcessing/CallFlow/CF_**_spec.rb"

    - stage: phoenix
      if: type IN (api, cron) AND env(PHOENIX) = true
      script: 'bundle exec rspec spec/features/CallProcessing/IVR_PHOENIX/**_spec.rb'

    - stage: prophecy
      if: type IN (api, cron) AND env(PROPHECY) = true
      script:
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Currency_PROPH_spec.rb'
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Date_PROPH_spec.rb'
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Go_To_LeadFlow_v1_spec.rb'
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Multiple_Choice_PROPH_spec.rb'
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Number_PROPH_spec.rb'
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Phone_Number_PROPH_spec.rb'
        - 'bundle exec rspec spec/features/CallProcessing/IVR_PROPHECY/IVR_Yes_No_PROPH_spec.rb'

    - stage: ivr-general
      if: type IN (api, cron) AND env(IVR_GEN) = true
      env: TAG=ivr
      script: "bundle exec rspec --profile --tag $TAG"

    - stage: transfer
      if: type IN (api, cron) AND env(TRANSFER) = true
      env: TAG=transfer
      script: "bundle exec rspec --profile --tag $TAG"

    - stage: audit
      script: "bundle exec bundle audit check --update"
      if: type IN (api, cron) AND env(AUDIT) = true
