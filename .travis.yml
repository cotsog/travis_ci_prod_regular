language: java
sudo: false

env:
  global:
    - CACHE_NAME=travis-cache

# caches for build artifacts
cache:
  directories:
    - $HOME/travis_cache

jobs:
  include:
    # build cache
    - stage: Build cache
      install: true
      script:
        - mv $HOME/travis_cache $HOME/travis_cache_old
        - mkdir $HOME/travis_cache
        - echo "$TRAVIS_BUILD_ID" > $HOME/travis_cache/travis_build_id

    # Check format
    - stage: Check format
      # do not use default install (runs formatter)
      install: true
      script:
        - ls $HOME/travis_cache/
        # check that cache has been filled in current build
        - if [ ! -f $HOME/travis_cache/travis_build_id ]; then travis_terminate 1; fi

    # build + test
    - stage: Build + test
      os: linux
      dist: trusty
      jdk: oraclejdk8
      addons:
        apt:
          packages: oracle-java8-installer
      install: true
      script:
        - ls $HOME/travis_cache/
        # check that cache has been filled in current build
        - if [ ! -f $HOME/travis_cache/travis_build_id ]; then travis_terminate 1; fi
    - stage: Build + test
      os: linux
      dist: trusty
      jdk: oraclejdk9
      addons:
        apt:
          packages: oracle-java9-installer
      install: true
      script:
        - ls $HOME/travis_cache/
        # check that cache has been filled in current build
        - if [ ! -f $HOME/travis_cache/travis_build_id ]; then travis_terminate 1; fi

    # Install packages
    # debug
    - stage: Install packages
      install: true
      script:
        - ls $HOME/travis_cache/
        # check that cache has been filled in current build
        - if [ ! -f $HOME/travis_cache/travis_build_id ]; then travis_terminate 1; fi
    - stage: Install packages
      install: true
      script:
        - ls $HOME/travis_cache/
        # check that cache has been filled in current build
        - if [ ! -f $HOME/travis_cache/travis_build_id ]; then travis_terminate 1; fi
