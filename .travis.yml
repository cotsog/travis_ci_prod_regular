language: cpp

notifications:
  email:
    on_success: never
    on_failure: never

matrix:
  include:
    # Mac OS.
    - os: osx
      osx_image: xcode8.3
      sudo: required
      env:
        - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7 && FC=gfortran-7"

virtualenv:
  # system_site_packages is needed for pip to be allowed to install packages in the system
  system_site_packages: true

before_install:
    - eval "${MATRIX_EVAL}"

install:

  # OS: update, upgrade.
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    cask uninstall oclint;                                             fi # conflicts with gcc.
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    update;                                                            fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    upgrade;                                                           fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    list -1 | while read line; do brew unlink             $line; done; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    list -1 | while read line; do brew   link --overwrite $line; done; fi

  # packages: install from repositories.
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install git;                  fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install gcc;                  fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install openmpi;              fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install boost-mpi;            fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install lapack;               fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install cmake diffutils;      fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install bzip2;                fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then      brew    install python --with-tcl-tk; fi
  - sudo pip install --upgrade --upgrade-strategy only-if-needed argparse numpy matplotlib # Same command for linux / osx.

before_script:

  # start X server to enable matplotlib to create images.
  - export DISPLAY=":99.0"
  - if [[ "$TRAVIS_OS_NAME" == "osx"   ]]; then ( sudo Xvfb :99 -ac -screen 0 1024x768x8; )& fi

script:

  # code quality.
  - pushd $TRAVIS_BUILD_DIR


  # compile openmpi and boost (travis ones may be outdated even after upgrade).
  - pushd $TRAVIS_BUILD_DIR
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then travis_wait 25 ./prq.sh openmpi; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then travis_wait 25 ./prq.sh boost; fi

  # build and install petsc and slepc.
  - pushd $TRAVIS_BUILD_DIR
  - travis_wait 25 ./prq.sh petsc
  - travis_wait 25 ./prq.sh slepc
  - export PATH="$TRAVIS_BUILD_DIR/prq/local/bin:${PATH}"
  - export LD_LIBRARY_PATH="$TRAVIS_BUILD_DIR/prq/local/lib:${LD_LIBRARY_PATH}"
  - export PKG_CONFIG_PATH="$TRAVIS_BUILD_DIR/prq/local/lib/pkgconfig:${PKG_CONFIG_PATH}"
  - export CMAKE_PREFIX_PATH="$TRAVIS_BUILD_DIR/prq/local:${CMAKE_PREFIX_PATH}"

  # tweak cmake on OSX (builds are slow: kill tests or get killed => keep only the first "dummy" test case).
  - pushd $TRAVIS_BUILD_DIR
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sed -i '' -e 's/^add_test/#add_test/' ./tst/laplacian/CMakeLists.txt; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sed -i '' -e 's/^add_test/#add_test/' ./tst/graph/CMakeLists.txt;     fi

  # build and test.
  - pushd $TRAVIS_BUILD_DIR
  - mkdir BUILD; pushd BUILD
  - cmake --version
  - export BOOST_FLAGS="-Wno-expansion-to-defined" # Prevent boost errors.
  - cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="-Wall -Wextra -Werror -pedantic -pedantic-errors $BOOST_FLAGS --coverage" ..
  - make VERBOSE=1
  - python -c "from mpl_toolkits.mplot3d import Axes3D"
