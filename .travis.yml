language: ruby
rvm: "2.3.6"
sudo: false
branches:
  only:
    - master
    - staging
    - /^feature\//  # Run on PRs and merges into branches prefixed with "feature/"
cache:
  bundler: true
before_script:
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - sleep 3 # give xvfb some time to start
  - cp config/database.default.yml config/database.yml
  - psql -c 'create database agencieshq_test;' -U postgres
  - yarn install
  - bundle exec rake testhq:prepare
env:
  global:
    - WICKED_PDF=/usr/bin/wkhtmltopdf
    - EAGER_LOAD=true
  matrix:
    - TESTFOLDER='spec/models'
    - TESTFOLDER='spec/importers spec/abilities spec/apis'
    - TESTFOLDER='spec/flatteners spec/workers spec/constants spec/controllers spec/data_converters spec/db'
    - TESTFOLDER='spec/tools spec/commands spec/features'
script:
  - bundle exec rspec $TESTFOLDER --order random
services:
  - memcached
  - redis-server
addons:
  postgresql: "10.1"
  code_climate:
    repo_token: 12345
  apt:
    - wkhtmltopdf
notifications:
  slack:
    rooms:
    - 12345
    on_success: never
    on_failure: always
